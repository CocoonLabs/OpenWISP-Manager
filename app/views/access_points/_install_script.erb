#!/bin/sh

PROGDIR=`dirname $0`

# Deploy new configuration
echo "Deploying new configuration"

# System
echo "Changing hostname"
echo "<%=h access_point.name %>" > /proc/sys/kernel/hostname

# Networking
echo "Applying network configuration"
# VPNs
<% access_point.l2vpn_clients.each do |v| -%>
echo "Creating tap <%=h v.tap.name %>"
openvpn --mktun --dev <%=h v.tap.name %> --dev-type tap
while [ -z "`grep <%=h v.tap.name %> /proc/net/dev`" ]; do
  sleep 1
  openvpn --mktun --dev <%=h v.tap.name %> --dev-type tap
done
<% end -%>

# Network
echo "Creating bridges"
uci -m import network -f ./uci/network.conf
<% access_point.bridges.each do |b| -%>
echo "Enabling bridge <%=h b.name %>"
ifup <%=h b.name %>
<% end -%>

# Wifi
echo "Applying wifi configuration"
uci -m import wireless -f ./uci/wireless.conf
echo "Enabling wifi"
<% access_point.radios.each do |r| -%>
wifi up <%= r.name %>
<% end -%>

# VPNs
echo "Applying l2 vpn(s) configuration"
<% if access_point.l2vpn_clients.length > 0 -%>
uci -m import openvpn -f ./uci/openvpn.conf
echo "Enabling l2 vpn(s)"
/etc/init.d/openvpn start
<% end -%>

# L2TCs
echo "Applying l2 tc configuration"
$PROGDIR/l2tc_script.sh start

# Cron Scripts

## Inherited from template
<% unless access_point.access_point_template.nil? -%>
    <% access_point.access_point_template.custom_script_templates.each do |c| -%>
echo "<%=c.cron_minute %> <%=c.cron_hour %> <%=c.cron_day %> <%=c.cron_month %> <%=c.cron_weekday %> $PROGDIR/cron_scripts/T_<%= c.name %>" >> $PROGDIR/cron.info
    <% end -%>
<% end -%>

## Owned by access point
<% access_point.custom_scripts.each do |c| -%>
echo "<%=c.cron_minute %> <%=c.cron_hour %> <%=c.cron_day %> <%=c.cron_month %> <%=c.cron_weekday %> $PROGDIR/cron_scripts/<%= c.name %>" >> $PROGDIR/cron.info
<% end -%>

# Add info to crontab
<% if (!access_point.access_point_template.nil? and access_point.access_point_template.custom_script_templates.length > 0) or  access_point.custom_scripts.length > 0 -%>
echo "Running Cron"
crond -c $PROGDIR/cron.info -l 5
<% end -%>

echo "New configuration now active"
